#!/usr/bin/env bash
set -e

echo "üöÄ Installing Vire Platform 1‚Äì7 (EOF-safe)"

ROOT="vire-agent"

CLI="$ROOT/cli"
EXPORT="$ROOT/export"
BUILD="$ROOT/build"
DEPLOY="$ROOT/deploy"
AGENT="$ROOT/agent"
ORCH="$ROOT/orchestrator"
TEMPLATES="$ROOT/templates/sites"
TOKENS="$ROOT/tokens"

mkdir -p \
  "$CLI" \
  "$EXPORT/pages" \
  "$BUILD" \
  "$DEPLOY" \
  "$AGENT" \
  "$ORCH" \
  "$TEMPLATES" \
  "$TOKENS"

# --------------------------------------------------
# 1Ô∏è‚É£ VIRE CLI
# --------------------------------------------------
cat <<'PY' > "$CLI/vire.py"
#!/usr/bin/env python3
import json, sys

if len(sys.argv) < 2:
    print("Usage: vire <site.json>")
    sys.exit(1)

spec = json.load(open(sys.argv[1]))

pages = spec.get("pages", [])
site_id = spec.get("site_id", "site")

print(f"‚úÖ Site generated: {site_id}")
print("Pages:", ", ".join(pages))
PY

chmod +x "$CLI/vire.py"

cat <<'SH' > "$CLI/vire"
#!/usr/bin/env bash
python3 "$(dirname "$0")/vire.py" "$@"
SH

chmod +x "$CLI/vire"

# --------------------------------------------------
# 2Ô∏è‚É£ STATIC ‚Üí WORDPRESS EXPORT
# --------------------------------------------------
cat <<'PY' > "$EXPORT/wp_static_export.py"
import os, json

BASE = "export/pages"
os.makedirs(BASE, exist_ok=True)

site = json.load(open("site.json"))

for page in site.get("pages", []):
    slug = page.lower().replace(" ", "-")
    html = f"""
<!-- wp:group -->
<div class="wp-block-group">
<h1>{page}</h1>
<p>Generated by Vire</p>
</div>
<!-- /wp:group -->
"""
    open(f"{BASE}/{slug}.html", "w").write(html)

print("‚úÖ Gutenberg-ready pages exported")
PY

# --------------------------------------------------
# 3Ô∏è‚É£ PHASE-2 BUILD SYSTEM (Tailwind v3 ONLY)
# --------------------------------------------------
cat <<'JS' > "$BUILD/tailwind.config.js"
module.exports = {
  content: ["../**/*.html"],
  theme: {
    extend: {
      colors: {
        primary: "#3b82f6",
        slatebg: "#020617"
      }
    }
  },
  plugins: []
}
JS

cat <<'CSS' > "$BUILD/input.css"
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --accent: #3b82f6;
  --bg: #020617;
}
CSS

cat <<'SH' > "$BUILD/build.sh"
#!/usr/bin/env bash
set -e

BIN="./node_modules/.bin/tailwindcss"

if [ ! -x "$BIN" ]; then
  echo "‚ùå Tailwind CLI not found"
  exit 1
fi

"$BIN" \
  -c tailwind.config.js \
  -i input.css \
  -o ../export/styles.css \
  --minify

echo "‚úÖ Phase-2 CSS compiled (Tailwind v3)"
SH

chmod +x "$BUILD/build.sh"

# --------------------------------------------------
# 4Ô∏è‚É£ WORDPRESS DEPLOY SCRIPT
# --------------------------------------------------
cat <<'SH' > "$DEPLOY/deploy_wp.sh"
#!/usr/bin/env bash
set -e

WP_CONTAINER="${WP_CONTAINER:-vireoka_wp}"

for f in export/pages/*.html; do
  TITLE=$(basename "$f" .html | sed 's/-/ /g')
  docker exec -i "$WP_CONTAINER" wp post create \
    --post_type=page \
    --post_title="$TITLE" \
    --post_status=publish \
    --post_content="$(cat "$f")" || true
done

echo "‚úÖ Pages deployed to WordPress"
SH

chmod +x "$DEPLOY/deploy_wp.sh"

# --------------------------------------------------
# 5Ô∏è‚É£ AI PROMPT ‚Üí SITE SPEC
# --------------------------------------------------
cat <<'PY' > "$AGENT/prompt_to_site.py"
import json

site = {
  "site_id": "ai-product",
  "pages": ["Home", "Features", "Pricing", "Contact"]
}

json.dump(site, open("site.json", "w"), indent=2)
print("‚úÖ site.json generated")
PY

# --------------------------------------------------
# 6Ô∏è‚É£ ORCHESTRATOR (ALL PRODUCTS)
# --------------------------------------------------
cat <<'SH' > "$ORCH/vire-all.sh"
#!/usr/bin/env bash
set -e

for f in templates/sites/*.json; do
  echo "‚öôÔ∏è Generating $f"
  ./cli/vire "$f"
done

echo "‚úÖ All product sites generated"
SH

chmod +x "$ORCH/vire-all.sh"

# --------------------------------------------------
# 7Ô∏è‚É£ TEMPLATES + TOKENS
# --------------------------------------------------
cat <<'JSON' > "$TEMPLATES/atmasphere.json"
{
  "site_id": "atmasphere",
  "pages": ["Home", "Philosophy", "Research", "Access"]
}
JSON

cat <<'JSON' > "$TEMPLATES/dating.json"
{
  "site_id": "dating",
  "pages": ["Home", "How It Works", "Communities", "Join"]
}
JSON

cat <<'JSON' > "$TEMPLATES/stablecoin.json"
{
  "site_id": "stablecoin",
  "pages": ["Home", "Security", "Compliance", "Early Access"]
}
JSON

cat <<'CSS' > "$TOKENS/figma_tokens.css"
:root {
  --primary: #3b82f6;
  --bg-dark: #020617;
  --text-main: #e5e7eb;
}
CSS

# --------------------------------------------------
# README
# --------------------------------------------------
cat <<'MD' > "$ROOT/README.md"
# Vire Agent Platform

Generate and deploy AI-powered websites.

## Generate
./cli/vire templates/sites/atmasphere.json

## Export
python3 export/wp_static_export.py

## Build
cd build && ./build.sh

## Deploy
WP_CONTAINER=vireoka_wp ./deploy/deploy_wp.sh
MD

echo "‚úÖ Vire Platform 1‚Äì7 installed successfully"
